<!--
@author: Ashutosh Mishra, BIT Mesra
@Desc : Cucumber JSON Report Render
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-chart/google-chart.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<!-- Custom Element -->
<link rel="import" href="../../bower_components/paper-datatable/paper-datatable.html">
<link rel="import" href="../../bower_components/iron-grid/iron-grid.html">
<!-- Paper Material -->
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<!-- Layout -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="nng-cucumber-reports">
    <!-- Starting template -->
    <template>

        <style>
            :host{
                display   : block;
                position  : relative;
                width     : 100%;
                @apply(--nng-cucumber-reports);
            }

            google-chart {
              width         : 100%;
              height        : 100%;
              /*position      : relative;
              padding       : 0px;*/
            }

            paper-material{
                width:100%;
                height:100%;
                margin: 0px;
                padding-bottom: 20px;
                padding-top: 20px;
                background-color: white;

                @apply(--layout-vertical);
                @apply(--layout-center);
                @apply(--nng-cucumber-reports-paper-material);
            }

            .counter_val {
                font-size: 5em;
                font-weight: 300;
                color: #2196F3;
                text-align: center;
                @apply(--nng-cucumber-reports-counter-value);
            }
            .counter_val_of{
                font-size: 0.3em;
                font-weight: 300;
                color: #2196F3;
                top: inherit;
                @apply(--nng-cucumber-reports-counter-value-of);
            }

            .counter_lbl{
                font-size: 0.9em;
                font-weight:lighter;
                @apply(--nng-cucumber-reports-counter-label);
            }
            .reportBanner{
                    font-weight:lighter;
            }
            .counter_unit{
                color: #2196F3;
                font-size: 0.8em;
                font-weight:lighter;
                @apply(--nng-cucumber-reports-counter-unit);
            }
            /* DIV/Card with All screen sizes */
            .graphbox {
                padding: 5px;
                background: transparent;
                @apply(--layout-vertical);
                @apply(--layout-center);
                @apply(--nng-cucumber-reports-graph);
            }

            .user-dialog{
                min-width: 70%;
                border-style: solid;
                border-width: 1px;
                border-color: cyan;
            }
            table.discTbl{
                    width:100%;
                    padding:0;
                    spacing: 0;
            }
            .discTblHeader{
                    background-color: #ccc;
                    border-style: none;
                    border-bottom-style: solid; border-bottom-width: 1px;
            }
            /*table.discTblHeader > tr > th {
                    align-items: center;
                    align-content: center;
            }*/
            td{
                    border-style: none;
                    border-bottom-style: solid; border-bottom-width: 1px;
            }
            .discArea, paper-material.dataTable{
                    text-align: left;
                    align-content: flex-start;
                    align-items: flex-start;
            }
            .discRow{
                    border-style: solid;
                    border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: black;
            }

            .hh {
                font-weight: bold;
                font-size: 1.5em;
                background-color: lightgray;
            }
        @media print {
                #uploadBtn * { display:none; }
                paper-material {
                        border-radius: 3px;
                        border-style: solid;
                        border-width: 1px;
                        border-color: inherit;
                        box-shadow: none;
                }
        }
        </style>

        <!-- Setting Iron ajax and calling an API to get data -->
        <iron-ajax
            id="ajax"
            url="http://localhost:3000/v1/reportdata"
            handle-as="json"
            method="GET"
            on-response="_onResponse"
            on-error="_onError"
            timeout="60000">
        </iron-ajax>

<!-- File Upload UI Part.
------------------------------------------------------>
        <!-- Upload Section -->
        <div id="uploadBtn">
                <paper-icon-button icon="icons:cloud-upload" data-dialog="modal" onclick="auth.open()" TITLE="Upload Cucmber json report file to generate intractive REPORT and take a print out."></paper-icon-button>
                <span>Upload Cucumber JSON file.</span>
                <button onclick="window.print();">Print Now</button>
        </div>
        <paper-dialog id="auth" class="user-dialog" alwaysOnTop="true">
                <h2> Upload your Cucumber Json report file here... </h2>
                <input type="file" name="file" id="file"/>
                <div class="buttons">
                        <paper-button dialog-cancel> CANCEL </paper-button>
                        <paper-button  dialog-confirm autofocus on-click="_checkFile" raised> GENERATE REPORT </paper-button>
                </div>
        </paper-dialog>

<!-- Report Generation part.
Main Content of Element will render here.
------------------------------------------------------>
        <iron-grid id="printarea">

                <!-- Header/Banner for Report. -->
                <template is="dom-if" if="[[isReportReady]]">
                        <paper-material>
                                <div class="reportBanner"> CUCUMBER REPORT </div>
                                <p>Test Results: </p>
                        </paper-material>
                </template>

                <!-- Total Report area. -->
                        <!-- dom repeat -->
                        <template is="dom-repeat" items="{{d}}" as="arr" index-as="i">
                                <!--
                                Dom if, Rendering Counter type
                                ------------------------------------------------->
                                <template is="dom-if" if="[[isCounterType(arr)]]">
                                        <div class="graphbox xl2 l2 m4 s12 xs12">
                                                <paper-material id="ppr-card" elevation="[[elevation]]">
                                                        <!-- Couter Graph title -->
                                                        <div class="counter_unit"><font color="[[arr.data.0.color]]"> [[arr.data.0.unit]] </font> </div>

                                                        <!-- Value /of -->
                                                        <div class="counter_val">
                                                        <!-- Value --><font color="[[arr.data.0.color]]"> [[arr.data.0.value]] </font>
                                                        <!-- Of --><span class="counter_val_of">[[isValOf(arr.data.0.of)]]</span>
                                                        </div>

                                                        <!-- counter label -->
                                                        <div class="counter_lbl"> [[arr.data.0.label]] </div>
                                                </paper-material>
                                        </div>
                                </template>

                                <!--
                                Dom if, Rendering Google chart
                                ------------------------------------------------->
                                <template is="dom-if" if="[[isGraphType(arr)]]">
                                        <div  class="graphbox xl6 l6 m6 s12 xs12">
                                                <paper-material elevation="[[elevation]]">
                                                        <!-- Simple Google chart. -->
                                                        <google-chart
                                                                id   = "gChart"
                                                                type = "[[arr.type]]"
                                                                data = '[[arr.data]]'
                                                                options ='[[setGraphOption(arr)]]'>
                                                        </google-chart>
                                                </paper-material>
                                        </div>
                                </template>

                                <!--
                                Dom if, Rendering discriptions
                                --------------------------------------------------->
                                <template is="dom-if" if="[[isDesciptionType(arr)]]">
                                        <div  class="graphbox xl12 l12 m12 s12 xs12">
                                                <!-- Data table For Feature Summary -->
                                                <paper-material class="dataTable" elevation="1">
                                                                <p style="padding:10px;"><font SIZE="3"><b> Feature File Summary </b></font></p>
                                                                <paper-datatable data="{{arr.data}}" style="width:100%;" selectable>
                                                                    <paper-datatable-column class="hh" header="FEATURE TITLE" property="name" sortable>
                                                                        [[name]]
                                                                    </paper-datatable-column>
                                                                    <paper-datatable-column class="hh" header="TEST COUNT" property="testCount" sortable>
                                                                        [[testCount]]
                                                                    </paper-datatable-column>
                                                                    <paper-datatable-column header="FEATURE FILE" property="uri" sortable>
                                                                        [[uri]]
                                                                    </paper-datatable-column>
                                                                </paper-datatable>
                                                </paper-material>
                                        </div>
                                        <div  class="graphbox xl12 l12 m12 s12 xs12">
                                                <!-- Data table For Test steps Summary -->
                                                <paper-material class="dataTable" elevation="1">
                                                                <p style="padding:10px;"><font SIZE="3"><b> Steps Summary </b></font></p>
                                                                <paper-datatable data="{{stepsTable}}" style="width:100%;" selectable>
                                                                    <paper-datatable-column header="STEP NAME" property="name" sortable>
                                                                        [[name]]
                                                                    </paper-datatable-column>
                                                                    <paper-datatable-column header="STEP STATUS" property="status" sortable>
                                                                        [[status]]
                                                                    </paper-datatable-column>
                                                                    <paper-datatable-column header="DURATION (nanos)" property="duration" sortable>
                                                                        [[duration]]
                                                                    </paper-datatable-column>
                                                                </paper-datatable>
                                                </paper-material>
                                        </div>
                                                        <!-- discription table -->
                                                        <!--paper-material class="discHeader" elevation="0">
                                                                <table class="discTbl" cellspacing="0" cellpadding="5" border="1">
                                                                        <tr class="discTblHeader"> <th>FEATURE</th> <th>SCENARIO</th> <th>TEST COUNT</th> </tr>

                                                                        <template is="dom-repeat" items="{{arr.data}}" as="feature" index-as="j">
                                                                                <tr style="border-style:none; border-bottom-style:solid; border-bottom-width:1px; border-bottom-color: #ccc;">
                                                                                        <td> [[feature.name]] </td>
                                                                                        <td>
                                                                                                <template is="dom-repeat" items="{{feature.scenario}}" as="scenario" index-as="k">
                                                                                                [[scenario.name]]<br/>
                                                                                                </template>
                                                                                        </td>
                                                                                        <td align="right" width="10%">
                                                                                                [[feature.testCount]]
                                                                                        </td>
                                                                                </tr>
                                                                        </template>
                                                                </table>
                                                        </paper-material --><!-- For table -->
                                </template>

                                <!--
                                Redering DataTable
                                ---------------------------------------------------->

                        </template><!-- End of data repeat template -->
        </iron-grid>

        <!--TODO: Toast, If Ajax call fails. -->
        <paper-toast id="toast">
          <!-- <span class="toast-hide-button" role="button" tabindex="0" onclick="app.$.toast.hide()">CLOSE</span> -->
        </paper-toast>

</template>

<script>
    Polymer({
        is: 'nng-cucumber-reports',

//** Element Properties
        properties:{
            //property which hold data from an API.
            data:{
                type: Array,
                value: function(){ return [];},
                notify: true
            },
            /* Property for paper card elevation(box-shadow) from outside */
            elevation:{
                type: Number,
                value: 1
            },
            /* Vars for Cucmber report */
                /* Array contains all the data to be rendered. */
                d:{
                        type: Array,
                        value: function(){ return []; },
                        notify: true
                },
                isReportReady:{
                        type: Boolean,
                        value: false,
                        notify: true
                },
                isTableReady:{
                        type: Boolean,
                        value: false,
                        notify: true
                },
                /* JSON Report File Data */
                jsonObject:{
                        type: Array,
                        value: function(){ return []; },
                        notify:true
                },
                /* Tests/Steps data. */
                stepsTable:{
                        type: Array,
                        value: function(){ return []; },
                        notify:true
                },

                /* Discription Data */
                discdata:{
                        type: Array,
                        value: function(){ return []; },
                        notify:true
                },


	    /* Property for Google chart customization */
            //Available OPTIONS
            graphOption:{
                type: Object,
                readOnly: true,
                value: function(){
                                return {
                                        lineSize:2,
                                        pieHole: 0.5,
                                        backgroundColor: {stroke:null, fill:'transparent', strokeSize: 1},
                                        title: "My Graph",
                                        legend: { position: "bottom" },
                                        chartArea:{left:0,top:0,right:0,height:"85%",width:"100%"},
                                        curveType: "function",
                                        colors: ['red', 'green', 'blue', '#f3b49f', '#f6c7b6'],
                                        animation:{duration: 1000,easing: 'out'},
                                        hAxis: { titleTextStyle: {color: '#333'}, gridlines: {color: '#f3f3f3',count: 0} },
                                        vAxis: { titleTextStyle: {color: '#333'}, minValue: 0, gridlines: {color: '#f3f3f3',count: 0}}
                                };
                }
            }
        },


        //Functions in case.
        //===[Checking types.]===================
        isGraphType: function(arr){
            return (arr.type !== 'counter')? true : false ;
        },
        isCounterType: function(arr){
            return (arr.type === 'counter')? true : false ;
        },
        isDesciptionType: function(arr){
                return (arr.type === 'discription')? true : false ;
        },
        isValOf: function(number){
            return (number)? '/'+number+'' : '';
        },
        //Set layout function.
        setLayout: function(arr){
            return (arr.fullWidth)? 'xl12 l12 m12 s12 xs12' : 'xl4 l4 m6 s12 xs12' ;
        },

        //Set graph Option.
        setGraphOption: function(arr){

            if(arr.option){
                    console.log("Using API graph Options.");
                	arr.option.legend 		= arr.option.legend || "bottom";
            		arr.option.pieHole 		= "pieHole" in arr.option ? arr.option.pieHole : 0.8;
            		arr.option.colors 		= "colors" in arr.option ? arr.option.colors 		: ['red', 'green', 'blue', '#f3b49f', '#f6c7b6'] ;  //Set color
            		arr.option.curveType 	= "curveType" in arr.option ? arr.option.curveType	: "function" ;                                      //Set curveType
            		arr.option.chartArea 	= "chartArea" in arr.option? arr.option.chartArea       	: {left:0,top:0,width:"100%",height:"85%"};         //Set chartArea
            		arr.option.hAxis 		= "hAxis" in arr.option  ? arr.option.hAxis              : { titleTextStyle: {color: '#333'}, gridlines: {color: '#f3f3f3',count: 0}, format: '####' } ;  //Set horizantal background axis
            		arr.option.vAxis		= "vAxis" in arr.option ? arr.option.vAxis              	: { minValue: 0, gridlines: {color: '#f3f3f3',count: 0}} ;  //Set horizantal background axis
            		arr.option.animation	= "animation" in arr.option ? arr.option.animation       	: {duration: 1000,easing: 'out',"startup": true} ;  //Set horizantal background axis
            		arr.option.backgroundColor = "backgroundColor" in arr.option ? arr.option.backgroundColor : {stroke:null, fill:null, strokeSize: 0} ;  //Set backgroundColor { fill:'transparent' }
            		//finally return the changes.
            		return arr.option;
            }else{
                console.log("Using default graph Options.");
		return this.graphOption;
	    }
		//return this.graphOption;
        },

        //IRON-AJAX Response
        _onResponse: function(e, resp){
            this.obj = (resp.response);
            this.data = (resp.response);
            console.dir(this.data);
        },

        _onError: function(error){
        	// TODO: Just show the error message, or we can retry here also.
        	console.log("Ajax failure, Response error: ");
                console.dir("Error: " + error);
                this.$.toast.text=" Failed ";
                this.$.toast.show();
    	},

        _checkFile: function(){

                        //Crearing old data.
                        //console.log('Cleaning old data of json Object.');
                        this.jsonObject = [];

                        //Reading File
                        var reader = new FileReader();
                        var self = this;

                        //Reading File
                        // Closure to capture the file information.
                        reader.onload = (function(theFile) {
                                                return function(e) {
                                                        JsonObj = JSON.parse(e.target.result);
                                                        //For Global use.
                                                        //this.jsonObject = JsonObj;
                                                        self.push('jsonObject', JsonObj);
                                                        self._update();
                                                };
                        })(this.$.file.files[0]);

                        //OnError [When file reader is unable to read file]
                        //reader.onerror = (function(e){console.dir(e);})();

                        // Read in the image file as a text.
                        reader.readAsText(this.$.file.files[0]);

        },

        _render: function() {
                //Enabling Report Banner/Header.
                this.isReportReady = true;

                //Variables for Graph options [for customisation purpose]
                var     lineGraphOption = {
                                animation : {duration: 1000,easing: 'out',"startup": true},
				lineSize:1,
				title: "Time Distribution for each test in scenario",
				legend: { position: "bottom" },
				chartArea:{width:"80%", height:"80%"},
				curveType: "function",
				colors: ['darkcyan', 'black', 'darkred', '#f3b49f', '#f6c7b6'],
				is3D: false,
				backgroundColor: {stroke:null, fill:'#FFF', strokeSize: 0},
				hAxis : { titleTextStyle: {color: '#333'}, gridlines: {color: '#f3f3f3',count: 5}, format: '####' },
				vAxis : { minValue: 0, gridlines: {color: '#f3f3f3'}}
                        },
                        pieGraphOptions = {
                                animation : {duration: 1000,easing: 'out',"startup": true},
                                title: 'Test Success %',
                                curveType: "function",
                                legend: { position: "right" },
                                chartArea:{width:"80%", height:"80%"},
                                pieHole: 0.6,
                                colors: ['darkgreen', 'darkred', 'darkgray']
                        };

                //Variable for main data.
                var     sampleobj = {},
                        basicDataTable = [], /* Contains Complete Structure for Discription */
                        featureTable = [],
                        scenarioTable = [],
                        testTable = [],
                        timeDistributionFortests = [];

                //Counter Variables
                var     totalFeature = (this.jsonObject[0]).length,
                        totalScenario = 0,
                        totalTest = 0,
                        totalPass = 0,
                        totalFail = 0,
                        totalSkipped = 0
                        testCounter = 0
                        featureIndex = -1;

                //Initial header/label for time distribution graph
                        timeDistributionFortests.push(["TEST","TIME-TAKEN-IN-SEC"]);
                //Processing now
                        (this.jsonObject[0]).forEach(

                                //Processing a feature.
                                function(featureObject){
                                        //Setting Feature file index.
                                        featureIndex ++;
                                        //Counting total scenario
                                        totalScenario += featureObject.elements.length;

                                        //Adding Feature into Feature table.
                                        //TODO: i should add this in last.
                                        //featureTable.push( {'name':featureObject.name, 'discription': featureObject.discription, 'uri':featureObject.uri} );

                                        //processing a scenario
                                        (featureObject.elements).forEach(
                                                function(scenarioObject){
                                                        //Counting total steps
                                                        totalTest += scenarioObject.steps.length;
                                                        testCounter += scenarioObject.steps.length;
                                                        //Processing a step/test.
                                                        (scenarioObject.steps).forEach(
                                                                function(stepObject){

                                                                        //Adding tests into test table.
                                                                        testTable.push( {'featureFileIndex': featureIndex, 'name':stepObject.keyword+'- '+stepObject.name, 'status': stepObject.result.status, 'duration':stepObject.result.duration} );

                                                                        //Recording step time.
                                                                        //console.log("Step Time:: " + stepObject.result.duration + ', ' + (stepObject.result.duration)/1000000000 );
                                                                        timeDistributionFortests.push([stepObject.keyword+' :: '+stepObject.name, (stepObject.result.duration)/1000000000 ]);
                                                                        //Counting step status
                                                                        (stepObject.result.status === 'passed') ? totalPass += 1 : ( (stepObject.result.status === 'failed')? totalFail += 1 : totalSkipped +=1 );

                                                                } /* End of test/step */);
                                                                //Adding Scenario into Scenario table.
                                                                scenarioTable.push( {'name':scenarioObject.name, 'discription': scenarioObject.discription, 'StepCount':scenarioObject.steps.length, 'steps': testTable} );
                                                } /* End of Scenario */

                                        );
                                        //now i push this result to an featureTable.
                                        featureTable.push( {'name':featureObject.name, 'discription': featureObject.discription, 'testCount':testCounter, 'uri':featureObject.uri, 'scenario': scenarioTable} );
                                        testCounter = 0;
                                }/*End of feature*/

                        );

                //Finally Adding the data to main variable which will render.
                                //Adding Pie graph.
                                        this.push('d', {"id":"pieChart","type":"pie", 'option':pieGraphOptions, "data":[ ["STATUS","VALUE"],["PASS",totalPass],["FAIL",totalFail],["SKIPPED",totalSkipped] ],"width":'4' } );

                                //Adding Time distribution by line Graph
                                        console.log(">>>>>>>>>>>>>>>>>>>>>>>>\n");
                                        this.stepsTable = testTable;
                                        /*Available chart types: line, pie, bar, column, area, combo*/
                                        this.push('d', { 'id':'Time-Distri-Graph', 'type':'area', 'data': timeDistributionFortests, 'option': lineGraphOption, 'width': '8'});
                                        console.dir(this.stepsTable);

                                //Adding Counters
                                        //Counter graph for total Feature.
                                        this.push('d', {'id': 'counter-chart', 'type':'counter', 'fullWidth':false, 'data': [ {'label':'TOTAL', 'value': totalFeature, 'unit':'FEATURE', 'color':'#2196F3'} ] });
                                        //Counter graph for total Scenario
                                        this.push('d', {'id': 'counter-chart', 'type':'counter', 'fullWidth':false, 'data': [ {'label':'TOTAL', 'value': totalScenario, 'unit':'SCENARIO', 'color':'#2196F3'} ] });
                                        //Counter graph for total Test.
                                        this.push('d', {'id': 'counter-chart', 'type':'counter', 'fullWidth':false, 'data': [ {'label':'TOTAL', 'value': totalTest, 'unit':'TEST', 'color':'#2196F3'} ] });

                                        //Counter graph for total Passed.
                                        this.push('d', {'id': 'counter-chart', 'type':'counter', 'fullWidth':false, 'data': [ {'label':'', 'value': totalPass, 'of':totalTest, 'unit':'PASS', 'color':'#0F0'} ] });
                                        //Counter graph for total Feature.
                                        this.push('d', {'id': 'counter-chart', 'type':'counter', 'fullWidth':false, 'data': [ {'label':'', 'value': totalFail, 'of':totalTest, 'unit':'FAIL', 'color':'#F00'} ] });
                                        //Counter graph for total Feature.
                                        this.push('d', {'id': 'counter-chart', 'type':'counter', 'fullWidth':false, 'data': [ {'label':'', 'value': totalSkipped, 'of':totalTest, 'unit':'UNKNOWN', 'color':'#ccc'} ] });

                                //Feature table is ready now
                                        console.log('Feature Table :::: ');
                                        console.dir(featureTable);

                                //Adding Discription table.
                                        this.push('d', {'id':'disc', 'type':'discription', 'data': featureTable});
        },

        _update: function(){
                console.log("Uploaded File: "+  this.$.file.files[0].name );
                console.log("File Rendered....");
                //Logging uploaded JSON File data
                //console.log(this.jsonObject);

                //A file is uploaded for rendering, so clean the old report first.
                //Rendering Graph from JSON REPORT..
                this._render();
        },

        attached: function(){
            //Setting Ajax Url
            this.$.ajax.url = "http://localhost:10000/v1/reportdata"

            //logging.
            console.log("Calling API at the Address >>>>>>>>", this.$.ajax.url);

            //Setting up ajax method.
            this.$.ajax.method = "GET";

            //now calling AJAX
            this.$.ajax.generateRequest();

        }//End of Attach.

    });

</script>
</dom-module>
